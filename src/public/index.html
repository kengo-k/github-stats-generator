<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@2"></script>
    <script src="https://code.highcharts.com/10.3/highcharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3.2.45/dist/vue.global.prod.js"></script>
  </head>
  <body>
    <div id="app" class="grid grid-cols-2 h-full">
      <!-- <div id="active_projects_chart" class="h-full"></div>
      <div id="used_languages_chart"></div> -->
      <my-languages />
    </div>
  </body>
  <script type="module">
    import "./init.js";
    const initUsedLanguagesChart = (chartData) => {
      const totalSize = chartData.totalSize;
      const langMap = chartData.languages;
      const keys = Object.keys(langMap);
      const seriesData = keys
        .map((key) => {
          return {
            name: key,
            y: langMap[key].size,
            color: langMap[key].color,
          };
        })
        .sort((a, b) => {
          if (a.y > b.y) {
            return -1;
          } else if (a.y === b.y) {
            return 0;
          } else {
            return 1;
          }
        });
      Highcharts.chart("used_languages_chart", {
        chart: {
          plotBackgroundColor: null,
          plotBorderWidth: null,
          plotShadow: false,
          type: "pie",
        },
        title: {
          text: "Used languages in projects",
        },
        tooltip: {
          pointFormat: "{series.name}: <b>{point.percentage:.1f}%</b>",
        },
        accessibility: {
          point: {
            valueSuffix: "%",
          },
        },
        plotOptions: {
          pie: {
            allowPointSelect: true,
            cursor: "pointer",
            dataLabels: {
              enabled: true,
              format: "<b>{point.name}</b>: {point.percentage:.1f} %",
            },
          },
        },
        series: [
          {
            name: "Brands",
            colorByPoint: true,
            data: seriesData,
          },
        ],
      });
    };

    const initActiveProjectsChart = (data) => {
      const repoMap = {};
      const dataMap = { keys: [], repos: repoMap };
      data.forEach((item) => {
        const since = item.since.substring(0, 7);
        if (!dataMap.keys.includes(since)) {
          dataMap.keys.push(since);
        }
        const repos = item.repos;
        for (const repo of repos) {
          const name = repo.name;
          if (!(name in repoMap)) {
            repoMap[name] = { name };
          }
          if (name in repoMap) {
            const data = repoMap[name];
            data[since] = repo.commit_count;
          }
        }
      });
      const repos = dataMap.repos;
      const series = Object.keys(repos).map((repoName) => {
        const repo = repos[repoName];
        const data = [];
        for (const key of dataMap.keys) {
          if (key in repo) {
            data.push(repo[key]);
          } else {
            data.push(0);
          }
        }
        return {
          name: repo.name,
          data,
        };
      });

      Highcharts.chart("active_projects_chart", {
        chart: {
          type: "column",
        },
        legend: {
          enabled: false,
        },
        title: {
          text: "Commits by project in the last 3 months",
        },

        xAxis: {
          categories: dataMap.keys,
        },

        yAxis: {
          allowDecimals: false,
          min: 0,
          title: {
            text: "Commit",
          },
        },

        tooltip: {
          formatter: function () {
            return (
              "<b>" + this.x + "</b><br/>" + this.series.name + ": " + this.y
            );
          },
        },

        plotOptions: {
          column: {
            stacking: "normal",
          },
        },

        series,
      });
    };
  </script>
</html>
